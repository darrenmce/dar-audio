/*! DarAudio - v0.1.0 - 2013-08-07
* https://github.com/darrenmce/dar-audio
* Copyright (c) 2013 Darren; Licensed MIT */
!function(a){"use strict";function b(a){var b=[],c=a||{},d=c.da;return b.push("<div"+jade.attrs({"class":[d.classes.row]},{"class":!0})+"><div"+jade.attrs({"class":[d.classes.span3]},{"class":!0})+'><label>Playlist:</label><select class="da-pl-select"></select></div><div'+jade.attrs({"class":[d.classes.span8]},{"class":!0})+'><div class="da-title"></div><div'+jade.attrs({"class":["da-progress",d.classes.progress]},{"class":!0})+'><div style="width: 0%;" class="bar bar-success"></div></div><div'+jade.attrs({"class":["da-loaded",d.classes.progress]},{"class":!0})+'><div style="width: 100%;" class="bar"></div></div><div'+jade.attrs({"class":["da-time",d.classes.textRight]},{"class":!0})+'><span class="da-time-progress"></span><span class="da-time-total"></span></div><div'+jade.attrs({"class":[d.classes.controlsContainer]},{"class":!0})+"><div"+jade.attrs({"class":[d.classes.row]},{"class":!0})+"><div"+jade.attrs({"class":[d.classes.span3]},{"class":!0})+"><div"+jade.attrs({"class":[d.classes.buttonGroup]},{"class":!0})+"><button"+jade.attrs({"class":["da-prev",d.classes.button]},{"class":!0})+"><i"+jade.attrs({"class":[d.classes.iconPrev]},{"class":!0})+"></i></button><button"+jade.attrs({"class":["da-play",d.classes.button]},{"class":!0})+"><i"+jade.attrs({"class":[d.classes.iconPlay]},{"class":!0})+"></i></button><button"+jade.attrs({"class":["da-pause",d.classes.button]},{"class":!0})+"><i"+jade.attrs({"class":[d.classes.iconPause]},{"class":!0})+"></i></button><button"+jade.attrs({"class":["da-next",d.classes.button]},{"class":!0})+"><i"+jade.attrs({"class":[d.classes.iconNext]},{"class":!0})+"></i></button></div></div><div"+jade.attrs({"class":["da-slider",d.classes.span3]},{"class":!0})+'><input type="range" min="0" max="100" step="1" value="50" class="da-volume"/></div></div></div></div></div><div'+jade.attrs({"class":[d.classes.row]},{"class":!0})+'><audio class="da-audio"><p>Your Browser Does Not Support HTML5 Audio</p></audio></div>'),b.join("")}var c={da:{classes:{row:"row-fluid",span3:"span3",span8:"span8",progress:"progress",textRight:"text-right",controlsContainer:"fluid-container",buttonGroup:"btn-group",button:"btn",iconPrev:"icon-step-backward",iconPlay:"icon-play",iconPause:"icon-pause",iconNext:"icon-step-forward"}}},d=function(a){this.name=a.name||"default",this.pos=0,this.playList=a.playList||"",this.index=0,this.loaded=!1,this.folder=a.folder||""};d.prototype={load:function(b){var c=this;c.loaded?"function"==typeof b&&b.call(c):"object"==typeof c.playList?(c.loaded=!0,"function"==typeof b&&b.call(c)):"string"==typeof c.playList&&a.getJSON(c.playList).done(function(a){c.playList=a.playList,c.loaded=!0,"function"==typeof b&&b.call(c)})},length:function(){return this.playList.length},getKey:function(a){return this.playList[this.pos][a]}};var e=function(b,d){this.$ele=a(b),this.volume=d.defaultVolume||.5,this.playList=0,this.playLists=[],this.playListDef=d.playListDef||[],this.TemplateLocals=d.templateLocals||c};e.prototype={loadPlayLists:function(){var b=this,c=0;return a.each(b.playListDef,function(){var a=this,e=new d(a);e.index=c,b.playLists.push(e),c++}),b},pl:function(){return this.playLists[this.playList]},play:function(){this.pl().pos<0?this.next():this.ap.canPlayType&&this.ap.canPlayType(this.pl().getKey("type"))?this.ap.play():confirm("Cannot Play Type: "+this.pl().getKey("type")+". Proceed to Next Song?")&&this.next()},pause:function(){this.ap.pause()},prev:function(){this.pl().pos--,this.pl().pos<0&&(this.pl().pos=this.pl().length()-1),this.ap.pause(),a(this.ap).attr("src",this.pl().folder+this.pl().getKey("url")),this.ap.load()},next:function(b){b||this.pl().pos++,this.pl().pos===this.pl().length()&&(this.pl().pos=0),this.pause(),a(this.ap).attr("src",this.pl().folder+this.pl().getKey("url")),this.ap.load()},seekTo:function(a){this.ap.currentTime=a},init:function(){var b=this;return this.ap=this.$ele.find(".da-audio").get(0),b.$ele.find(".da-play").on("click",function(){b.play()}),b.$ele.find(".da-pause").on("click",function(){b.pause()}),b.$ele.find(".da-prev").on("click",function(){b.prev()}),b.$ele.find(".da-next").on("click",function(){b.next()}),b.$ele.find(".da-progress").on("click",function(a){var c=parseInt(b.$ele.find(".da-progress").css("width"),10);b.seekTo(a.offsetX/c*b.ap.duration)}).css("cursor","pointer"),a.each(b.playLists,function(){var c=this;b.$ele.find(".da-pl-select").append(a("<option>"+c.name+"</option>").attr("value",c.index)).on("change",function(){b.playList=a(this).val(),b.pl().load(function(){b.next(!0)})})}),b.$ele.find(".da-pl-select").val(b.playList),b.$ele.find(".da-volume").on("change",function(){b.volume=b.ap.volume=this.value/100}),a(b.ap).bind("loadstart",function(){b.ap.volume=b.volume,b.$ele.find(".da-title").html(a("<h2></h2>").html(b.pl().getKey("Title"))),b.$ele.find(".da-progress .bar").css("width",0),b.$ele.find(".da-loaded").addClass("progress-striped progress-danger active").find(".bar").css("width","100%")}),a(b.ap).bind("loadedmetadata",function(){b.$ele.find(".da-time-progress").html("0:00"),b.$ele.find(".da-time-total").html(" / "+b.msToTimeStamp(b.ap.duration))}),a(b.ap).bind("timeupdate",function(){var a=parseInt(b.$ele.find(".da-progress").css("width"),10),c=Math.ceil(a*b.ap.currentTime/b.ap.duration);b.$ele.find(".da-time-progress").html(b.msToTimeStamp(b.ap.currentTime)),b.$ele.find(".da-progress .bar").css("width",c)}),a(b.ap).bind("progress",function(){var a=parseInt(b.$ele.find(".da-progress").css("width"),10),c=Math.ceil(a*(this.buffered.length>0&&this.buffered.end(0))/this.duration);c>0&&b.$ele.find(".da-loaded").removeClass("progress-striped progress-danger active").find(".bar").removeClass("bar-danger"),b.$ele.find(".da-loaded .bar").css("width",c)}),a(b.ap).bind("canplay",function(){b.play()}),a(b.ap).bind("ended",function(){b.next()}),b.playLists.length<=0?b.$ele.find(".da-title").html("<h2>No Playlist Loaded.</h2>"):this.pl().load(function(){b.next(!0)}),b},msToTimeStamp:function(a){var b=Math.floor(a%31536e3%86400%3600/60),c=""+Math.floor(a%31536e3%86400%3600%60);return c.length<2&&(c="0"+c),b+":"+c},loadHtml:function(){var a=this;return this.$ele.html(b(a.TemplateLocals)),a}},a.fn.daraudio=function(b){var c=b||{};return this.each(function(){var b=a(this),d=b.data("daraudio");d||(b.data("daraudio",d=new e(this,c)),d.loadHtml().loadPlayLists().init())})},a.fn.daraudio.Constructor=e}(jQuery);